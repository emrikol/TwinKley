name: Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: macos-14

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          brew install swiftlint swiftformat pngquant

      - name: Setup signing
        env:
          SIGNING_CERTIFICATE: ${{ secrets.SIGNING_CERTIFICATE }}
          SIGNING_PASSWORD: ${{ secrets.SIGNING_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain

          # Import certificate
          echo "$SIGNING_CERTIFICATE" | base64 --decode > cert.p12
          security import cert.p12 -k build.keychain -P "$SIGNING_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" build.keychain

      - name: Setup notarization
        env:
          NOTARIZATION_APPLE_ID: ${{ secrets.NOTARIZATION_APPLE_ID }}
          NOTARIZATION_TEAM_ID: ${{ secrets.NOTARIZATION_TEAM_ID }}
          NOTARIZATION_PASSWORD: ${{ secrets.NOTARIZATION_PASSWORD }}
        run: |
          xcrun notarytool store-credentials "notarytool" \
            --apple-id "$NOTARIZATION_APPLE_ID" \
            --team-id "$NOTARIZATION_TEAM_ID" \
            --password "$NOTARIZATION_PASSWORD"

      - name: Run tests
        run: swift test

      - name: Build and notarize
        run: ./build.sh --release --notarize

      - name: Create distribution ZIP
        run: |
          cd ~/Applications
          ditto -c -k --keepParent TwinKley.app TwinKley.zip
          mv TwinKley.zip $GITHUB_WORKSPACE/

      - name: Create DMG installer
        run: |
          # Create temporary folder for DMG contents
          mkdir -p dmg-temp
          cp -R ~/Applications/TwinKley.app dmg-temp/
          ln -s /Applications dmg-temp/Applications

          # Create DMG
          hdiutil create -volname "TwinKley" \
            -srcfolder dmg-temp \
            -ov -format UDZO \
            TwinKley-temp.dmg

          # Convert to read-write for signing
          hdiutil convert TwinKley-temp.dmg -format UDRW -o TwinKley-rw.dmg

          # Sign the DMG
          codesign --force --sign "Developer ID Application" TwinKley-rw.dmg

          # Convert back to compressed read-only
          hdiutil convert TwinKley-rw.dmg -format UDZO -o TwinKley.dmg

          # Staple notarization ticket to DMG
          xcrun stapler staple TwinKley.dmg

          # Clean up
          rm -f TwinKley-temp.dmg TwinKley-rw.dmg
          rm -rf dmg-temp

      - name: Sign update with Sparkle
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          # Write private key to file
          echo "$SPARKLE_PRIVATE_KEY" > sparkle_key.txt

          # Sign the update
          .build/artifacts/sparkle/Sparkle/bin/sign_update TwinKley.zip -f sparkle_key.txt > signature.txt

          # Clean up private key
          rm -f sparkle_key.txt

          # Display signature for verification
          cat signature.txt

      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Generate appcast
        env:
          SPARKLE_PRIVATE_KEY: ${{ secrets.SPARKLE_PRIVATE_KEY }}
        run: |
          # Create releases directory for appcast generation
          mkdir -p releases
          cp TwinKley.zip releases/

          # Generate appcast for CURRENT release only
          echo "$SPARKLE_PRIVATE_KEY" | .build/artifacts/sparkle/Sparkle/bin/generate_appcast \
            --download-url-prefix "https://github.com/emrikol/TwinKley/releases/download/${{ steps.version.outputs.tag }}/" \
            --ed-key-file - \
            releases/

          # Download existing appcast from GitHub Pages
          if curl -f -s -o old-appcast.xml https://emrikol.github.io/TwinKley/appcast.xml; then
            echo "Merging with existing appcast..."

            # Extract new <item> from generated appcast to a file
            sed -n '/<item>/,/<\/item>/p' releases/appcast.xml > new-item.xml

            # Split old appcast at <channel> tag and insert new item
            # Get everything before and including <channel>
            sed -n '1,/<channel>/p' old-appcast.xml > appcast.xml

            # Add new item
            cat new-item.xml >> appcast.xml

            # Add everything after <channel> from old appcast
            sed -n '/<channel>/,$p' old-appcast.xml | tail -n +2 >> appcast.xml

            echo "Merged appcast created"
          else
            echo "No existing appcast, using new one"
            mv releases/appcast.xml appcast.xml
          fi

          # Clean up
          rm -rf releases old-appcast.xml new-item.xml

      - name: Extract release notes from CHANGELOG
        id: release_notes
        run: |
          # Extract the latest version section from CHANGELOG.md
          # This gets everything between the first ## [version] and the next ## [version]
          VERSION=${{ steps.version.outputs.version }}

          # Create release notes file
          awk "/## \[$VERSION\]/ {flag=1; next} /## \[/ {flag=0} flag" CHANGELOG.md > release_notes.md

          # If release notes are empty, use a default message
          if [ ! -s release_notes.md ]; then
            echo "Release $VERSION" > release_notes.md
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            TwinKley.dmg
            TwinKley.zip
            appcast.xml
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.ref, 'beta') || contains(github.ref, 'alpha') || contains(github.ref, 'rc') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare appcast for GitHub Pages
        run: |
          mkdir -p gh-pages
          cp appcast.xml gh-pages/

      - name: Publish appcast to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: gh-pages
          keep_files: false
          publish_branch: gh-pages
          enable_jekyll: false
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Update appcast.xml for ${{ steps.version.outputs.tag }}'

      - name: Auto-increment build number
        run: |
          # Extract current build number
          BUILD_NUM=$(grep 'static let buildNumber = ' Packages/TwinKleyCore/Sources/TwinKleyCore/Settings.swift | sed 's/.*= \([0-9]*\).*/\1/')
          NEXT_BUILD_NUM=$((BUILD_NUM + 1))

          # Increment in Settings.swift
          sed -i '' "s/static let buildNumber = ${BUILD_NUM}/static let buildNumber = ${NEXT_BUILD_NUM}/" Packages/TwinKleyCore/Sources/TwinKleyCore/Settings.swift

          # Commit and push back to main
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Packages/TwinKleyCore/Sources/TwinKleyCore/Settings.swift
          git commit -m "chore: bump buildNumber to ${NEXT_BUILD_NUM} [skip ci]"
          git push origin HEAD:main

          echo "✨ Auto-incremented buildNumber: ${BUILD_NUM} → ${NEXT_BUILD_NUM}"

      - name: Cleanup keychain
        if: always()
        run: |
          security delete-keychain build.keychain || true
